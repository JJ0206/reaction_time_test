<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ìˆœë°œë ¥ í…ŒìŠ¤íŠ¸ | Reaction Time Test</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{--bg-idle:#3498db;--bg-waiting:#e74c3c;--bg-ready:#2ecc71;--bg-result:#1a1a2e;--bg-too-early:#e67e22;--transition-speed:0.45s}
html,body{height:100%;overflow:hidden;font-family:'Noto Sans KR',sans-serif;-webkit-tap-highlight-color:transparent;user-select:none;-webkit-user-select:none}
body{background:var(--bg-idle);color:#fff;transition:background var(--transition-speed) ease;cursor:pointer}
.particles{position:fixed;inset:0;pointer-events:none;overflow:hidden;z-index:0}
.particle{position:absolute;border-radius:50%;background:rgba(255,255,255,0.08);animation:float linear infinite}
@keyframes float{0%{transform:translateY(100vh) scale(0);opacity:0}10%{opacity:1}90%{opacity:1}100%{transform:translateY(-10vh) scale(1);opacity:0}}
#app{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:20px;text-align:center}
.round-bar{position:fixed;top:24px;left:50%;transform:translateX(-50%);display:flex;gap:48px;z-index:10;opacity:0;transition:opacity 0.4s ease}
.round-bar.visible{opacity:1}
.round-dot{width:16px;height:16px;border-radius:50%;background:rgba(255,255,255,0.25);border:2px solid rgba(255,255,255,0.5);transition:all 0.3s ease;position:relative}
.round-dot.success{background:#2ecc71;border-color:#2ecc71;box-shadow:0 0 8px rgba(46,204,113,0.6)}
.round-dot.active{border-color:#fff;transform:scale(1.3);animation:pulse-dot 1s ease infinite}
@keyframes pulse-dot{0%,100%{box-shadow:0 0 0 0 rgba(255,255,255,0.4)}50%{box-shadow:0 0 0 6px rgba(255,255,255,0)}}
.round-dot .dot-time{position:absolute;top:24px;left:50%;transform:translateX(-50%);font-size:11px;font-family:'Orbitron',monospace;white-space:nowrap;opacity:0.85}
.content{display:flex;flex-direction:column;align-items:center;gap:16px;animation:fadeIn 0.5s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(15px)}to{opacity:1;transform:translateY(0)}}
.icon{font-size:64px;line-height:1;animation:bounceIn 0.6s cubic-bezier(0.34,1.56,0.64,1)}
@keyframes bounceIn{0%{transform:scale(0)}100%{transform:scale(1)}}
.title{font-family:'Orbitron','Noto Sans KR',sans-serif;font-size:clamp(28px,6vw,48px);font-weight:900;letter-spacing:-1px;text-shadow:0 4px 20px rgba(0,0,0,0.2)}
.subtitle{font-size:clamp(16px,3vw,22px);font-weight:400;opacity:0.9;max-width:500px;line-height:1.6}
.hint{font-size:14px;opacity:0.6;margin-top:10px;animation:blink 2s ease infinite}
@keyframes blink{0%,100%{opacity:0.6}50%{opacity:0.2}}
.result-card{background:rgba(255,255,255,0.08);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.12);border-radius:24px;padding:40px 48px;margin-top:10px;animation:cardIn 0.5s cubic-bezier(0.34,1.56,0.64,1)}
@keyframes cardIn{0%{transform:scale(0.8);opacity:0}100%{transform:scale(1);opacity:1}}
.time-display{font-family:'Orbitron',monospace;font-size:clamp(48px,12vw,80px);font-weight:900;line-height:1;text-shadow:0 0 40px rgba(255,255,255,0.2)}
.time-unit{font-size:clamp(20px,4vw,28px);font-weight:700;opacity:0.7;margin-left:4px}
.grade{font-size:clamp(18px,3.5vw,24px);margin-top:12px;font-weight:700}
.summary-card{background:rgba(255,255,255,0.06);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.1);border-radius:24px;padding:36px 40px;max-width:420px;width:100%;animation:cardIn 0.5s cubic-bezier(0.34,1.56,0.64,1)}
.summary-title{font-family:'Orbitron',sans-serif;font-size:16px;text-transform:uppercase;letter-spacing:3px;opacity:0.6;margin-bottom:8px}
.summary-avg{font-family:'Orbitron',monospace;font-size:clamp(42px,10vw,64px);font-weight:900}
.summary-list{display:flex;justify-content:center;gap:12px;margin-top:20px;flex-wrap:wrap}
.summary-item{background:rgba(255,255,255,0.1);border-radius:12px;padding:8px 14px;font-family:'Orbitron',monospace;font-size:13px;font-weight:700}
.btn-group{display:flex;gap:12px;margin-top:24px;flex-wrap:wrap;justify-content:center}
.btn{padding:14px 32px;border:none;border-radius:14px;font-family:'Noto Sans KR',sans-serif;font-size:16px;font-weight:700;cursor:pointer;transition:all 0.2s ease;outline:none}
.btn:active{transform:scale(0.95)}
.btn-primary{background:#fff;color:#1a1a2e}
.btn-primary:hover{background:#f0f0f0;transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,0.15)}
.btn-secondary{background:rgba(255,255,255,0.15);color:#fff;border:2px solid rgba(255,255,255,0.3)}
.btn-secondary:hover{background:rgba(255,255,255,0.25);transform:translateY(-2px)}
.flash-overlay{position:fixed;inset:0;background:#fff;opacity:0;pointer-events:none;z-index:100;transition:opacity 0.1s ease}
.flash-overlay.flash{opacity:0.15;transition:opacity 0s}
.ripple{position:fixed;border-radius:50%;background:rgba(255,255,255,0.2);transform:scale(0);animation:rippleAnim 0.6s ease-out forwards;pointer-events:none;z-index:5}
@keyframes rippleAnim{to{transform:scale(4);opacity:0}}
@media(max-width:480px){
  .result-card{padding:28px 24px}.summary-card{padding:24px 20px}.btn{padding:12px 24px;font-size:14px}
  .round-dot{width:14px;height:14px}.round-bar{gap:36px}.round-dot .dot-time{font-size:10px;top:22px}
}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;z-index:200;animation:fadeIn 0.3s ease}
.modal{background:#1a1a2e;border:1px solid rgba(255,255,255,0.15);border-radius:24px;padding:36px;max-width:400px;width:90%;text-align:center;animation:cardIn 0.4s cubic-bezier(0.34,1.56,0.64,1)}
.modal h3{font-family:'Orbitron',sans-serif;font-size:18px;margin-bottom:20px}
.modal input{width:100%;padding:14px 18px;border:2px solid rgba(255,255,255,0.2);border-radius:12px;background:rgba(255,255,255,0.05);color:#fff;font-family:'Noto Sans KR',sans-serif;font-size:16px;outline:none;transition:border-color 0.3s ease}
.modal input:focus{border-color:#3498db}
.modal .btn-group{margin-top:20px}
.modal .input-error{color:#e74c3c;font-size:13px;margin-top:8px;min-height:20px}
.modal .result-preview{display:flex;justify-content:center;gap:20px;margin-bottom:20px;font-size:14px;opacity:0.8}
.modal .result-preview .preview-item{text-align:center}
.modal .result-preview .preview-value{font-family:'Orbitron',monospace;font-size:20px;font-weight:900;display:block;margin-top:4px}
.spinner{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin 0.6s linear infinite;vertical-align:middle;margin-right:8px}
@keyframes spin{to{transform:rotate(360deg)}}
.ranking-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(10px);display:flex;align-items:center;justify-content:center;z-index:200;animation:fadeIn 0.3s ease}
.ranking-modal{background:#1a1a2e;border:1px solid rgba(255,255,255,0.12);border-radius:24px;padding:32px 24px;max-width:520px;width:92%;max-height:85vh;overflow-y:auto;text-align:center;animation:cardIn 0.4s cubic-bezier(0.34,1.56,0.64,1)}
.ranking-modal::-webkit-scrollbar{width:6px}
.ranking-modal::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.15);border-radius:3px}
.ranking-modal h2{font-family:'Orbitron',sans-serif;font-size:22px;margin-bottom:20px}
.lb-header{display:flex;align-items:center;padding:6px 16px;font-size:11px;text-transform:uppercase;letter-spacing:1px;opacity:0.4;gap:8px}
.lb-header .lbh-rank{width:36px;text-align:center;flex-shrink:0}
.lb-header .lbh-name{flex:1;text-align:left;margin-left:4px}
.lb-header .lbh-device{width:24px;flex-shrink:0}
.lb-header .lbh-best{width:60px;text-align:right;flex-shrink:0}
.lb-header .lbh-time{width:75px;text-align:right;flex-shrink:0}
.lb-entry{display:flex;align-items:center;padding:10px 16px;background:rgba(255,255,255,0.06);border-radius:12px;margin-bottom:6px;animation:fadeIn 0.3s ease;gap:8px}
.lb-entry.lb-highlight{background:rgba(52,152,219,0.25);border:1px solid rgba(52,152,219,0.5)}
.lb-entry .lb-rank{font-family:'Orbitron',monospace;font-weight:900;font-size:16px;width:36px;text-align:center;flex-shrink:0}
.lb-entry .lb-name{flex:1;font-weight:700;margin-left:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:left}
.lb-entry .lb-device{font-size:16px;flex-shrink:0;width:24px;text-align:center}
.lb-entry .lb-best{font-family:'Orbitron',monospace;font-size:12px;opacity:0.5;flex-shrink:0;width:60px;text-align:right}
.lb-entry .lb-time{font-family:'Orbitron',monospace;font-weight:700;font-size:15px;color:#2ecc71;flex-shrink:0;width:75px;text-align:right}
.lb-entry:nth-child(2) .lb-time{color:#f1c40f}
.lb-entry:nth-child(3) .lb-time{color:#bdc3c7}
.lb-entry:nth-child(4) .lb-time{color:#e67e22}
.ranking-close-btn{margin-top:20px;padding:12px 36px;background:rgba(255,255,255,0.1);border:2px solid rgba(255,255,255,0.2);border-radius:14px;color:#fff;font-family:'Noto Sans KR',sans-serif;font-size:15px;font-weight:700;cursor:pointer;transition:all 0.2s ease}
.ranking-close-btn:hover{background:rgba(255,255,255,0.2)}
.ranking-empty{padding:40px 20px;opacity:0.5;font-size:15px}
.ranking-loading{padding:40px 20px;font-size:15px;opacity:0.6}
.ranking-error{padding:20px;color:#e74c3c;font-size:14px}
.idle-ranking-btn{margin-top:16px;padding:10px 24px;background:rgba(255,255,255,0.15);border:2px solid rgba(255,255,255,0.3);border-radius:12px;color:#fff;font-family:'Noto Sans KR',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all 0.2s ease}
.idle-ranking-btn:hover{background:rgba(255,255,255,0.25);transform:translateY(-2px)}
.toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%) translateY(20px);background:rgba(46,204,113,0.9);color:#fff;padding:12px 28px;border-radius:14px;font-weight:700;font-size:15px;z-index:300;opacity:0;transition:all 0.4s ease;pointer-events:none}
.toast.toast-error{background:rgba(231,76,60,0.9)}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
</style>
</head>
<body>
<div class="particles" id="particles"></div>
<div class="flash-overlay" id="flash"></div>
<div class="round-bar" id="roundBar"></div>
<div id="app"></div>
<div class="toast" id="toast"></div>

<script type="module">
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Firebase Setup
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAzMJKQJq3KrpCku9_oN0FQkBtYZHXUM38",
  authDomain: "gamedata-f49bd.firebaseapp.com",
  projectId: "gamedata-f49bd",
  storageBucket: "gamedata-f49bd.firebasestorage.app",
  messagingSenderId: "638830085387",
  appId: "1:638830085387:web:1ca04241b20bfd8cde8e0e",
  measurementId: "G-41CHL8RJSY"
};

let db = null;
let firebaseReady = false;

try {
  const app = initializeApp(firebaseConfig);
  db = getFirestore(app);
  firebaseReady = true;
  console.log('Firebase connected');
} catch (err) {
  console.warn('Firebase init failed, offline mode:', err);
}

function getDeviceType() {
  return /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent) ? 'Mobile' : 'PC';
}

async function fbSave({ nickname, avgTime, bestTime, attempts, grade }) {
  if (!firebaseReady) throw new Error('offline');
  const ref = await addDoc(collection(db, 'rankings'), {
    nickname, avgTime, bestTime, attempts, grade,
    deviceType: getDeviceType(),
    createdAt: serverTimestamp()
  });
  return ref.id;
}

async function fbLoad(topN = 20) {
  if (!firebaseReady) return [];
  const q = query(collection(db, 'rankings'), orderBy('avgTime', 'asc'), limit(topN));
  const snap = await getDocs(q);
  return snap.docs.map(d => ({ id: d.id, ...d.data() }));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Game Logic
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STATES = { IDLE:'IDLE', WAITING:'WAITING', READY:'READY', RESULT:'RESULT', TOO_EARLY:'TOO_EARLY', FINAL:'FINAL' };
const MAX_ROUNDS = 5;
const GRADES = [
  { max:150, emoji:'âš¡', text:'ë²ˆê°œ ë°˜ì‚¬ì‹ ê²½!' },
  { max:250, emoji:'ğŸ”¥', text:'ë§¤ìš° ë¹ ë¦„!' },
  { max:350, emoji:'ğŸ‘', text:'í‰ê·  ì´ìƒ!' },
  { max:500, emoji:'ğŸ˜Š', text:'ë³´í†µ' },
  { max:Infinity, emoji:'ğŸ¢', text:'ì¡°ê¸ˆ ëŠë ¤ìš”~' },
];
const BG = { IDLE:'#3498db', WAITING:'#e74c3c', READY:'#2ecc71', RESULT:'#1a1a2e', TOO_EARLY:'#e67e22', FINAL:'#1a1a2e' };

let state = STATES.IDLE;
let round = 0;
let results = [];
let startTime = 0;
let waitTimeout = null;
let registeredDocId = null;

const $ = s => document.querySelector(s);
const appEl = $('#app');
const roundBar = $('#roundBar');
const flash = $('#flash');
const toastEl = $('#toast');

function showToast(msg, isErr=false) {
  toastEl.textContent = msg;
  toastEl.className = 'toast' + (isErr ? ' toast-error' : '');
  requestAnimationFrame(() => toastEl.classList.add('show'));
  setTimeout(() => toastEl.classList.remove('show'), 2500);
}

function createParticles() {
  const c = $('#particles');
  for (let i = 0; i < 20; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    const sz = Math.random()*60+10;
    p.style.width = sz+'px'; p.style.height = sz+'px';
    p.style.left = Math.random()*100+'%';
    p.style.animationDuration = (Math.random()*10+8)+'s';
    p.style.animationDelay = (Math.random()*10)+'s';
    c.appendChild(p);
  }
}

function setBg(s) { document.body.style.background = BG[s]; }
function getGrade(ms) { return GRADES.find(g => ms <= g.max); }

function flashScreen() {
  flash.classList.add('flash');
  setTimeout(() => flash.classList.remove('flash'), 100);
}

function createRipple(x, y) {
  const r = document.createElement('div');
  r.className = 'ripple';
  r.style.left = (x-50)+'px'; r.style.top = (y-50)+'px';
  r.style.width = '100px'; r.style.height = '100px';
  document.body.appendChild(r);
  setTimeout(() => r.remove(), 600);
}

function esc(str) {
  const d = document.createElement('div');
  d.textContent = str; return d.innerHTML;
}

// â”€â”€ Round Bar â”€â”€
function renderRoundBar() {
  roundBar.innerHTML = '';
  if (state === STATES.IDLE && round === 0) { roundBar.classList.remove('visible'); return; }
  roundBar.classList.add('visible');
  for (let i = 0; i < MAX_ROUNDS; i++) {
    const dot = document.createElement('div');
    dot.className = 'round-dot';
    if (i < results.length) {
      dot.classList.add('success');
      const t = document.createElement('span');
      t.className = 'dot-time'; t.textContent = results[i].time+'ms';
      dot.appendChild(t);
    } else if (i === results.length) {
      dot.classList.add('active');
    }
    roundBar.appendChild(dot);
  }
}

// â”€â”€ Render â”€â”€
function renderIdle() {
  appEl.innerHTML = `
    <div class="content">
      <div class="icon">ğŸ¯</div>
      <div class="title">ìˆœë°œë ¥ í…ŒìŠ¤íŠ¸</div>
      <div class="subtitle">í™”ë©´ì´ ì´ˆë¡ìƒ‰ìœ¼ë¡œ ë°”ë€Œë©´<br>ìµœëŒ€í•œ ë¹ ë¥´ê²Œ í´ë¦­í•˜ì„¸ìš”!</div>
      <div class="subtitle" style="font-size:15px;opacity:0.7;">5íšŒ ì¸¡ì • í›„ í‰ê·  ë°˜ì‘ì†ë„ë¥¼ í™•ì¸í•©ë‹ˆë‹¤</div>
      <div class="hint">í™”ë©´ì„ í´ë¦­í•˜ì—¬ ì‹œì‘</div>
      <button class="idle-ranking-btn" id="btnIdleRank">ğŸ† ë­í‚¹ ë³´ê¸°</button>
    </div>`;
  $('#btnIdleRank').addEventListener('click', e => { e.stopPropagation(); showRankingBoard(); });
}

function renderWaiting() {
  appEl.innerHTML = `
    <div class="content">
      <div class="icon">ğŸ”´</div>
      <div class="title" style="font-size:clamp(22px,5vw,36px);">ê¸°ë‹¤ë¦¬ì„¸ìš”...</div>
      <div class="subtitle">ì´ˆë¡ìƒ‰ìœ¼ë¡œ ë°”ë€Œë©´ í´ë¦­!</div>
    </div>`;
}

function renderReady() {
  appEl.innerHTML = `
    <div class="content">
      <div class="icon">ğŸŸ¢</div>
      <div class="title">ì§€ê¸ˆ í´ë¦­í•˜ì„¸ìš”!</div>
    </div>`;
}

function renderResult(ms) {
  const g = getGrade(ms);
  appEl.innerHTML = `
    <div class="content">
      <div class="result-card">
        <div class="icon">${g.emoji}</div>
        <div class="time-display">${ms}<span class="time-unit">ms</span></div>
        <div class="grade">${g.text}</div>
      </div>
      <div class="hint">${round < MAX_ROUNDS ? 'í´ë¦­í•˜ì—¬ ë‹¤ìŒ ë¼ìš´ë“œ' : ''}</div>
    </div>`;
}

function renderTooEarly() {
  appEl.innerHTML = `
    <div class="content">
      <div class="icon">âš ï¸</div>
      <div class="title" style="font-size:clamp(22px,5vw,32px);">ë„ˆë¬´ ë¹¨ë¦¬ í´ë¦­í–ˆìŠµë‹ˆë‹¤!</div>
      <div class="subtitle">ì´ ë¼ìš´ë“œë¥¼ ë‹¤ì‹œ ì‹œë„í•©ë‹ˆë‹¤</div>
      <div class="hint">í´ë¦­í•˜ì—¬ ì¬ì‹œë„</div>
    </div>`;
}

function renderFinal() {
  const times = results.map(r => r.time);
  const avg = Math.round(times.reduce((a,b) => a+b, 0) / times.length);
  const best = Math.min(...times);
  const grade = getGrade(avg);
  const listHtml = results.map((r,i) => `<div class="summary-item">${i+1}. ${r.time}ms</div>`).join('');

  const rankBtn = registeredDocId
    ? '<button class="btn btn-secondary" disabled style="opacity:0.4;">âœ… ë“±ë¡ ì™„ë£Œ</button>'
    : '<button class="btn btn-secondary" id="btnRank">ğŸ† ë­í‚¹ ë“±ë¡</button>';

  appEl.innerHTML = `
    <div class="content">
      <div class="summary-card">
        <div class="summary-title">í‰ê·  ë°˜ì‘ì†ë„</div>
        <div class="icon">${grade.emoji}</div>
        <div class="summary-avg">${avg}<span class="time-unit">ms</span></div>
        <div class="grade">${grade.text}</div>
        <div class="summary-list">${listHtml}</div>
        <div class="btn-group">
          <button class="btn btn-primary" id="btnRetry">ë‹¤ì‹œ í•˜ê¸°</button>
          ${rankBtn}
          <button class="btn btn-secondary" id="btnViewRank">ğŸ“Š ë­í‚¹ ë³´ê¸°</button>
        </div>
      </div>
    </div>`;

  $('#btnRetry').addEventListener('click', e => { e.stopPropagation(); resetGame(); });
  const br = $('#btnRank');
  if (br) br.addEventListener('click', e => { e.stopPropagation(); showRegisterModal(avg, best, grade); });
  $('#btnViewRank').addEventListener('click', e => { e.stopPropagation(); showRankingBoard(); });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Firebase UI - Register Modal
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showRegisterModal(avg, best, grade) {
  if (!firebaseReady) { showToast('ì„œë²„ ì—°ê²° ì‹¤íŒ¨. ì˜¤í”„ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤.', true); return; }

  const ov = document.createElement('div');
  ov.className = 'modal-overlay';
  ov.innerHTML = `
    <div class="modal">
      <h3>ğŸ† ë­í‚¹ ë“±ë¡</h3>
      <div class="result-preview">
        <div class="preview-item">í‰ê· <span class="preview-value">${avg}ms</span></div>
        <div class="preview-item">ìµœê³ <span class="preview-value">${best}ms</span></div>
        <div class="preview-item">ë“±ê¸‰<span class="preview-value">${grade.emoji}</span></div>
      </div>
      <input type="text" id="rnkName" placeholder="ë‹‰ë„¤ì„ (2~10ì, í•œê¸€/ì˜ë¬¸/ìˆ«ì)" maxlength="10" autocomplete="off">
      <div class="input-error" id="rnkErr"></div>
      <div class="btn-group">
        <button class="btn btn-primary" id="rnkSave">ë“±ë¡í•˜ê¸°</button>
        <button class="btn btn-secondary" id="rnkCancel">ì·¨ì†Œ</button>
      </div>
    </div>`;
  document.body.appendChild(ov);

  const inp = ov.querySelector('#rnkName');
  const errEl = ov.querySelector('#rnkErr');
  const saveBtn = ov.querySelector('#rnkSave');
  inp.focus();

  function validate(n) {
    if (n.length < 2) return 'ë‹‰ë„¤ì„ì€ 2ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.';
    if (n.length > 10) return 'ë‹‰ë„¤ì„ì€ 10ì ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.';
    if (!/^[ê°€-í£a-zA-Z0-9]+$/.test(n)) return 'í•œê¸€, ì˜ë¬¸, ìˆ«ìë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.';
    return null;
  }

  const doSave = async () => {
    const name = inp.value.trim();
    const err = validate(name);
    if (err) { errEl.textContent = err; inp.style.borderColor = '#e74c3c'; return; }

    saveBtn.innerHTML = '<span class="spinner"></span>ë“±ë¡ ì¤‘...';
    saveBtn.disabled = true;
    errEl.textContent = '';

    try {
      const docId = await fbSave({
        nickname: name, avgTime: avg, bestTime: best,
        attempts: results.map(r => r.time),
        grade: grade.emoji + ' ' + grade.text
      });
      registeredDocId = docId;
      ov.remove();
      showToast('ğŸ‰ ë­í‚¹ ë“±ë¡ ì™„ë£Œ!');
      renderFinal();
    } catch (error) {
      console.error('Save failed:', error);
      saveBtn.innerHTML = 'ì¬ì‹œë„';
      saveBtn.disabled = false;
      errEl.textContent = 'ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
    }
  };

  saveBtn.addEventListener('click', e => { e.stopPropagation(); doSave(); });
  ov.querySelector('#rnkCancel').addEventListener('click', e => { e.stopPropagation(); ov.remove(); });
  inp.addEventListener('keydown', e => { if (e.key === 'Enter') doSave(); });
  ov.addEventListener('click', e => { if (e.target === ov) ov.remove(); });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Firebase UI - Ranking Board Modal
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function showRankingBoard() {
  const ov = document.createElement('div');
  ov.className = 'ranking-modal-overlay';
  ov.innerHTML = `
    <div class="ranking-modal">
      <h2>ğŸ† ë­í‚¹ ë³´ë“œ</h2>
      <div id="rkContent"><div class="ranking-loading"><span class="spinner"></span> ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div>
      <button class="ranking-close-btn" id="rkClose">ë‹«ê¸°</button>
    </div>`;
  document.body.appendChild(ov);

  ov.querySelector('#rkClose').addEventListener('click', e => { e.stopPropagation(); ov.remove(); });
  ov.addEventListener('click', e => { if (e.target === ov) ov.remove(); });

  const ct = ov.querySelector('#rkContent');

  if (!firebaseReady) {
    ct.innerHTML = '<div class="ranking-error">ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.</div>';
    return;
  }

  try {
    const data = await fbLoad(20);
    if (data.length === 0) {
      ct.innerHTML = '<div class="ranking-empty">ì•„ì§ ë“±ë¡ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì²« ë²ˆì§¸ ë„ì „ìê°€ ë˜ì–´ë³´ì„¸ìš”! ğŸš€</div>';
      return;
    }

    const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
    let html = `<div class="lb-header">
      <span class="lbh-rank">#</span><span class="lbh-name">ë‹‰ë„¤ì„</span>
      <span class="lbh-device"></span><span class="lbh-best">ìµœê³ </span><span class="lbh-time">í‰ê· </span>
    </div>`;

    data.forEach((e, i) => {
      const me = e.id === registeredDocId;
      const dev = e.deviceType === 'Mobile' ? 'ğŸ“±' : 'ğŸ–¥ï¸';
      const rk = i < 3 ? medals[i] : (i+1);
      html += `<div class="lb-entry${me?' lb-highlight':''}" style="animation-delay:${i*0.04}s">
        <span class="lb-rank">${rk}</span>
        <span class="lb-name">${esc(e.nickname)}${me?' â­':''}</span>
        <span class="lb-device">${dev}</span>
        <span class="lb-best">${e.bestTime||'â€”'}ms</span>
        <span class="lb-time">${e.avgTime}ms</span>
      </div>`;
    });
    ct.innerHTML = html;
  } catch (err) {
    console.error('Load failed:', err);
    ct.innerHTML = '<div class="ranking-error">ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.</div>';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  State Machine
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function transition(newState, data) {
  state = newState;
  setBg(state);
  renderRoundBar();
  switch (state) {
    case STATES.IDLE: renderIdle(); break;
    case STATES.WAITING:
      renderWaiting();
      waitTimeout = setTimeout(() => transition(STATES.READY), 2000 + Math.random()*3000);
      break;
    case STATES.READY: flashScreen(); startTime = performance.now(); renderReady(); break;
    case STATES.RESULT: flashScreen(); results.push({ time: data }); renderResult(data); break;
    case STATES.TOO_EARLY: renderTooEarly(); break;
    case STATES.FINAL: renderFinal(); break;
  }
}

function handleClick(e) {
  if (e.type === 'touchstart') e.preventDefault();
  const x = e.clientX || (e.touches?.[0]?.clientX ?? innerWidth/2);
  const y = e.clientY || (e.touches?.[0]?.clientY ?? innerHeight/2);
  createRipple(x, y);

  switch (state) {
    case STATES.IDLE:
      results = []; round = 1; registeredDocId = null;
      transition(STATES.WAITING); break;
    case STATES.WAITING:
      clearTimeout(waitTimeout);
      transition(STATES.TOO_EARLY); break;
    case STATES.READY:
      transition(STATES.RESULT, Math.round(performance.now() - startTime)); break;
    case STATES.RESULT:
      if (round < MAX_ROUNDS) { round++; transition(STATES.WAITING); }
      else transition(STATES.FINAL);
      break;
    case STATES.TOO_EARLY:
      transition(STATES.WAITING); break;
    case STATES.FINAL: break;
  }
}

function resetGame() {
  state = STATES.IDLE; round = 0; results = []; registeredDocId = null;
  clearTimeout(waitTimeout); setBg(STATES.IDLE); renderRoundBar(); renderIdle();
}

// â”€â”€ Init â”€â”€
createParticles();
transition(STATES.IDLE);
document.body.addEventListener('click', handleClick);
document.body.addEventListener('touchstart', handleClick, { passive: false });
document.body.addEventListener('contextmenu', e => e.preventDefault());
</script>
</body>
</html>
