<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<meta name="description" content="ìˆœë°œë ¥ í…ŒìŠ¤íŠ¸ - ë‹¹ì‹ ì˜ ë°˜ì‘ì†ë„ë¥¼ ì¸¡ì •í•´ë³´ì„¸ìš”! 5íšŒ ì¸¡ì • í›„ í‰ê·  ë°˜ì‘ì†ë„ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.">
<meta property="og:title" content="ğŸ¯ ìˆœë°œë ¥ í…ŒìŠ¤íŠ¸ | Reaction Time Test">
<meta property="og:description" content="ë‹¹ì‹ ì˜ ë°˜ì‘ì†ë„ëŠ” ì–¼ë§ˆë‚˜ ë¹ ë¥¼ê¹Œìš”? ì§€ê¸ˆ ë°”ë¡œ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”!">
<meta property="og:url" content="https://jj0206.github.io/reaction_time_test/reaction-time-test.html">
<meta property="og:type" content="website">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>ìˆœë°œë ¥ í…ŒìŠ¤íŠ¸ | Reaction Time Test</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root {
  --bg-idle:#1a1a2e;--bg-idle-light:#e8f4fd;
  --bg-waiting:#e74c3c;--bg-ready:#2ecc71;
  --bg-result:#1a1a2e;--bg-result-light:#f0f4f8;
  --bg-too-early:#e67e22;
  --text-primary:#fff;--text-primary-light:#1a1a2e;
  --card-bg:rgba(255,255,255,0.08);--card-bg-light:rgba(0,0,0,0.05);
  --card-border:rgba(255,255,255,0.12);--card-border-light:rgba(0,0,0,0.08);
  --transition-speed:0.45s;
  --neon-blue:#00d4ff;--neon-pink:#ff006e;--neon-glow:0 0 10px var(--neon-blue),0 0 30px var(--neon-blue),0 0 60px var(--neon-blue);
}
html,body{height:100%;overflow:hidden;font-family:'Noto Sans KR',sans-serif;-webkit-tap-highlight-color:transparent;user-select:none;-webkit-user-select:none;touch-action:manipulation}
body{background:var(--bg-idle);color:var(--text-primary);transition:background var(--transition-speed) ease,color 0.3s ease;cursor:pointer}
body.light-mode{background:var(--bg-idle-light);color:var(--text-primary-light)}

/* â”€â”€ Particles â”€â”€ */
.particles{position:fixed;inset:0;pointer-events:none;overflow:hidden;z-index:0}
.particle{position:absolute;border-radius:50%;background:rgba(255,255,255,0.06);animation:float linear infinite}
body.light-mode .particle{background:rgba(0,0,0,0.04)}
@keyframes float{0%{transform:translateY(100vh) scale(0);opacity:0}10%{opacity:1}90%{opacity:1}100%{transform:translateY(-10vh) scale(1);opacity:0}}

/* â”€â”€ Layout â”€â”€ */
#app{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:20px;text-align:center}

/* â”€â”€ Top Controls â”€â”€ */
.top-controls{position:fixed;top:16px;right:16px;display:flex;gap:8px;z-index:50}
.ctrl-btn{width:44px;height:44px;border-radius:12px;border:2px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.08);color:#fff;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s ease;backdrop-filter:blur(10px)}
.ctrl-btn:hover{background:rgba(255,255,255,0.15);transform:scale(1.05)}
body.light-mode .ctrl-btn{border-color:rgba(0,0,0,0.15);background:rgba(0,0,0,0.05);color:#1a1a2e}
body.light-mode .ctrl-btn:hover{background:rgba(0,0,0,0.1)}

/* â”€â”€ Round Bar â”€â”€ */
.round-bar{position:fixed;top:24px;left:50%;transform:translateX(-50%);display:flex;gap:48px;z-index:10;opacity:0;transition:opacity 0.4s ease}
.round-bar.visible{opacity:1}
.round-dot{width:16px;height:16px;border-radius:50%;background:rgba(255,255,255,0.25);border:2px solid rgba(255,255,255,0.5);transition:all 0.3s ease;position:relative}
.round-dot.success{background:#2ecc71;border-color:#2ecc71;box-shadow:0 0 8px rgba(46,204,113,0.6)}
.round-dot.active{border-color:#fff;transform:scale(1.3);animation:pulse-dot 1s ease infinite}
@keyframes pulse-dot{0%,100%{box-shadow:0 0 0 0 rgba(255,255,255,0.4)}50%{box-shadow:0 0 0 6px rgba(255,255,255,0)}}
.round-dot .dot-time{position:absolute;top:24px;left:50%;transform:translateX(-50%);font-size:11px;font-family:'Orbitron',monospace;white-space:nowrap;opacity:0.85}

/* â”€â”€ Content â”€â”€ */
.content{display:flex;flex-direction:column;align-items:center;gap:16px;animation:fadeIn 0.5s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(15px)}to{opacity:1;transform:translateY(0)}}
.icon{font-size:64px;line-height:1;animation:bounceIn 0.6s cubic-bezier(0.34,1.56,0.64,1)}
@keyframes bounceIn{0%{transform:scale(0)}100%{transform:scale(1)}}

/* â”€â”€ Neon Title â”€â”€ */
.neon-title{font-family:'Orbitron',sans-serif;font-size:clamp(32px,7vw,56px);font-weight:900;letter-spacing:2px;color:var(--neon-blue);text-shadow:var(--neon-glow);animation:neonFlicker 3s ease-in-out infinite}
body.light-mode .neon-title{color:#2563eb;text-shadow:0 2px 20px rgba(37,99,235,0.3)}
@keyframes neonFlicker{0%,100%{text-shadow:var(--neon-glow);opacity:1}50%{text-shadow:0 0 5px var(--neon-blue),0 0 15px var(--neon-blue);opacity:0.95}}
.neon-subtitle{font-family:'Orbitron',sans-serif;font-size:clamp(12px,2.5vw,16px);font-weight:700;color:var(--neon-pink);text-shadow:0 0 8px var(--neon-pink);letter-spacing:4px;text-transform:uppercase;margin-top:-4px}
body.light-mode .neon-subtitle{color:#e11d48;text-shadow:none}

.title{font-family:'Orbitron','Noto Sans KR',sans-serif;font-size:clamp(28px,6vw,48px);font-weight:900;letter-spacing:-1px;text-shadow:0 4px 20px rgba(0,0,0,0.2)}
.subtitle{font-size:clamp(16px,3vw,22px);font-weight:400;opacity:0.9;max-width:500px;line-height:1.6}
.hint{font-size:14px;opacity:0.6;margin-top:10px;animation:blink 2s ease infinite}
@keyframes blink{0%,100%{opacity:0.6}50%{opacity:0.2}}

/* â”€â”€ Idle Descriptions â”€â”€ */
.idle-desc{display:flex;flex-direction:column;gap:10px;margin:12px 0}
.idle-desc-item{font-size:15px;opacity:0;animation:descSlideIn 0.5s ease forwards}
.idle-desc-item:nth-child(1){animation-delay:0.3s}
.idle-desc-item:nth-child(2){animation-delay:0.6s}
.idle-desc-item:nth-child(3){animation-delay:0.9s}
@keyframes descSlideIn{from{opacity:0;transform:translateY(10px)}to{opacity:0.8;transform:translateY(0)}}

/* â”€â”€ Start Button â”€â”€ */
.start-btn{margin-top:20px;padding:18px 52px;border:none;border-radius:16px;font-family:'Orbitron',sans-serif;font-size:18px;font-weight:900;cursor:pointer;color:#fff;background:linear-gradient(135deg,#00d4ff,#7b2ff7);box-shadow:0 0 20px rgba(0,212,255,0.3),0 8px 32px rgba(0,0,0,0.2);animation:startPulse 2s ease infinite;transition:transform 0.2s ease;letter-spacing:1px}
.start-btn:hover{transform:scale(1.05)}
.start-btn:active{transform:scale(0.97)}
@keyframes startPulse{0%,100%{box-shadow:0 0 20px rgba(0,212,255,0.3),0 8px 32px rgba(0,0,0,0.2)}50%{box-shadow:0 0 35px rgba(0,212,255,0.5),0 8px 32px rgba(0,0,0,0.2)}}

/* â”€â”€ Countdown â”€â”€ */
.countdown-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:150;pointer-events:all}
.countdown-num{font-family:'Orbitron',sans-serif;font-size:clamp(100px,25vw,180px);font-weight:900;color:#fff;animation:countPop 0.7s cubic-bezier(0.34,1.56,0.64,1);text-shadow:0 0 40px rgba(255,255,255,0.3)}
@keyframes countPop{0%{transform:scale(2);opacity:0}40%{transform:scale(0.9);opacity:1}100%{transform:scale(1);opacity:1}}
.countdown-label{position:absolute;bottom:25%;font-size:18px;opacity:0.5;font-weight:700}

/* â”€â”€ Result Card â”€â”€ */
.result-card{background:var(--card-bg);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid var(--card-border);border-radius:24px;padding:40px 48px;margin-top:10px;animation:cardIn 0.5s cubic-bezier(0.34,1.56,0.64,1);position:relative;overflow:hidden}
body.light-mode .result-card{background:var(--card-bg-light);border-color:var(--card-border-light)}
@keyframes cardIn{0%{transform:scale(0.8);opacity:0}100%{transform:scale(1);opacity:1}}
.time-display{font-family:'Orbitron',monospace;font-size:clamp(48px,12vw,80px);font-weight:900;line-height:1;text-shadow:0 0 40px rgba(255,255,255,0.2)}
body.light-mode .time-display{text-shadow:none}
.time-unit{font-size:clamp(20px,4vw,28px);font-weight:700;opacity:0.7;margin-left:4px}
.grade{font-size:clamp(18px,3.5vw,24px);margin-top:12px;font-weight:700}
.comparison{font-size:14px;margin-top:8px;font-weight:700}
.comparison.improved{color:#2ecc71}
.comparison.declined{color:#e74c3c}

/* â”€â”€ Celebration Particles â”€â”€ */
.celebration{position:absolute;inset:0;pointer-events:none;overflow:hidden}
.confetti{position:absolute;width:8px;height:8px;border-radius:2px;animation:confettiFall linear forwards}
@keyframes confettiFall{0%{transform:translateY(-20px) rotate(0deg);opacity:1}100%{transform:translateY(400px) rotate(720deg);opacity:0}}
.sparkle{position:absolute;width:4px;height:4px;border-radius:50%;background:#fff;animation:sparkleFade 1s ease-out forwards}
@keyframes sparkleFade{0%{transform:scale(0);opacity:1}50%{transform:scale(1.5);opacity:1}100%{transform:scale(0);opacity:0}}

/* â”€â”€ Summary Card â”€â”€ */
.summary-card{background:var(--card-bg);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid var(--card-border);border-radius:24px;padding:36px 40px;max-width:440px;width:100%;animation:cardIn 0.5s cubic-bezier(0.34,1.56,0.64,1)}
body.light-mode .summary-card{background:var(--card-bg-light);border-color:var(--card-border-light)}
.summary-title{font-family:'Orbitron',sans-serif;font-size:16px;text-transform:uppercase;letter-spacing:3px;opacity:0.6;margin-bottom:8px}
.summary-avg{font-family:'Orbitron',monospace;font-size:clamp(42px,10vw,64px);font-weight:900}
.summary-stats{display:flex;justify-content:center;gap:24px;margin-top:16px;font-size:13px;opacity:0.7}
.summary-stats .stat-item{text-align:center}
.summary-stats .stat-value{font-family:'Orbitron',monospace;font-size:18px;font-weight:900;display:block;margin-top:2px;opacity:1}

/* â”€â”€ Bar Graph â”€â”€ */
.bar-graph{display:flex;align-items:flex-end;justify-content:center;gap:8px;height:80px;margin-top:20px;padding:0 10px}
.bar-col{display:flex;flex-direction:column;align-items:center;gap:4px;flex:1}
.bar{width:100%;max-width:48px;border-radius:6px 6px 0 0;background:linear-gradient(180deg,var(--neon-blue),#7b2ff7);transition:height 0.6s cubic-bezier(0.34,1.56,0.64,1);min-height:4px}
body.light-mode .bar{background:linear-gradient(180deg,#3b82f6,#8b5cf6)}
.bar-label{font-size:10px;font-family:'Orbitron',monospace;opacity:0.6}
.bar-value{font-size:10px;font-family:'Orbitron',monospace;font-weight:700;opacity:0.8}

.summary-list{display:flex;justify-content:center;gap:12px;margin-top:20px;flex-wrap:wrap}
.summary-item{background:rgba(255,255,255,0.1);border-radius:12px;padding:8px 14px;font-family:'Orbitron',monospace;font-size:13px;font-weight:700}
body.light-mode .summary-item{background:rgba(0,0,0,0.06)}

/* â”€â”€ Badge â”€â”€ */
.grade-badge{display:inline-flex;align-items:center;gap:6px;margin-top:12px;padding:8px 20px;border-radius:30px;font-size:15px;font-weight:900;background:linear-gradient(135deg,rgba(255,255,255,0.12),rgba(255,255,255,0.04));border:1px solid rgba(255,255,255,0.15);backdrop-filter:blur(10px)}
body.light-mode .grade-badge{background:linear-gradient(135deg,rgba(0,0,0,0.06),rgba(0,0,0,0.02));border-color:rgba(0,0,0,0.1)}

/* â”€â”€ Buttons â”€â”€ */
.btn-group{display:flex;gap:12px;margin-top:24px;flex-wrap:wrap;justify-content:center}
.btn{padding:14px 32px;border:none;border-radius:14px;font-family:'Noto Sans KR',sans-serif;font-size:16px;font-weight:700;cursor:pointer;transition:all 0.2s ease;outline:none}
.btn:active{transform:scale(0.95)}
.btn-primary{background:#fff;color:#1a1a2e}
.btn-primary:hover{background:#f0f0f0;transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,0.15)}
.btn-secondary{background:rgba(255,255,255,0.15);color:#fff;border:2px solid rgba(255,255,255,0.3)}
.btn-secondary:hover{background:rgba(255,255,255,0.25);transform:translateY(-2px)}
body.light-mode .btn-secondary{background:rgba(0,0,0,0.06);color:#1a1a2e;border-color:rgba(0,0,0,0.15)}
body.light-mode .btn-secondary:hover{background:rgba(0,0,0,0.1)}

/* â”€â”€ Flash / Ripple â”€â”€ */
.flash-overlay{position:fixed;inset:0;background:#fff;opacity:0;pointer-events:none;z-index:100;transition:opacity 0.1s ease}
.flash-overlay.flash{opacity:0.15;transition:opacity 0s}
.ripple{position:fixed;border-radius:50%;background:rgba(255,255,255,0.2);transform:scale(0);animation:rippleAnim 0.6s ease-out forwards;pointer-events:none;z-index:5}
@keyframes rippleAnim{to{transform:scale(4);opacity:0}}

/* â”€â”€ Responsive â”€â”€ */
@media(max-width:480px){
  .result-card{padding:28px 24px}.summary-card{padding:24px 20px}.btn{padding:12px 24px;font-size:14px}
  .round-dot{width:14px;height:14px}.round-bar{gap:36px}.round-dot .dot-time{font-size:10px;top:22px}
  .start-btn{padding:16px 40px;font-size:16px}
  .bar-graph{height:60px}
}

/* â”€â”€ Modal â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;z-index:200;animation:fadeIn 0.3s ease}
.modal{background:#1a1a2e;border:1px solid rgba(255,255,255,0.15);border-radius:24px;padding:36px;max-width:400px;width:90%;text-align:center;animation:cardIn 0.4s cubic-bezier(0.34,1.56,0.64,1)}
.modal h3{font-family:'Orbitron',sans-serif;font-size:18px;margin-bottom:20px}
.modal input{width:100%;padding:14px 18px;border:2px solid rgba(255,255,255,0.2);border-radius:12px;background:rgba(255,255,255,0.05);color:#fff;font-family:'Noto Sans KR',sans-serif;font-size:16px;outline:none;transition:border-color 0.3s ease}
.modal input:focus{border-color:#00d4ff}
.modal .btn-group{margin-top:20px}
.modal .input-error{color:#e74c3c;font-size:13px;margin-top:8px;min-height:20px}
.modal .result-preview{display:flex;justify-content:center;gap:20px;margin-bottom:20px;font-size:14px;opacity:0.8}
.modal .result-preview .preview-item{text-align:center}
.modal .result-preview .preview-value{font-family:'Orbitron',monospace;font-size:20px;font-weight:900;display:block;margin-top:4px}
.spinner{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin 0.6s linear infinite;vertical-align:middle;margin-right:8px}
@keyframes spin{to{transform:rotate(360deg)}}

/* â”€â”€ Ranking Modal â”€â”€ */
.ranking-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(10px);display:flex;align-items:center;justify-content:center;z-index:200;animation:fadeIn 0.3s ease}
.ranking-modal{background:#1a1a2e;border:1px solid rgba(255,255,255,0.12);border-radius:24px;padding:32px 24px;max-width:520px;width:92%;max-height:85vh;overflow-y:auto;text-align:center;animation:cardIn 0.4s cubic-bezier(0.34,1.56,0.64,1)}
.ranking-modal::-webkit-scrollbar{width:6px}
.ranking-modal::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.15);border-radius:3px}
.ranking-modal h2{font-family:'Orbitron',sans-serif;font-size:22px;margin-bottom:20px}
.lb-header{display:flex;align-items:center;padding:6px 16px;font-size:11px;text-transform:uppercase;letter-spacing:1px;opacity:0.4;gap:8px}
.lb-header .lbh-rank{width:36px;text-align:center;flex-shrink:0}
.lb-header .lbh-name{flex:1;text-align:left;margin-left:4px}
.lb-header .lbh-device{width:24px;flex-shrink:0}
.lb-header .lbh-best{width:60px;text-align:right;flex-shrink:0}
.lb-header .lbh-time{width:75px;text-align:right;flex-shrink:0}
.lb-entry{display:flex;align-items:center;padding:10px 16px;background:rgba(255,255,255,0.06);border-radius:12px;margin-bottom:6px;animation:fadeIn 0.3s ease;gap:8px}
.lb-entry.lb-highlight{background:rgba(0,212,255,0.15);border:1px solid rgba(0,212,255,0.4)}
.lb-entry .lb-rank{font-family:'Orbitron',monospace;font-weight:900;font-size:16px;width:36px;text-align:center;flex-shrink:0}
.lb-entry .lb-name{flex:1;font-weight:700;margin-left:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:left}
.lb-entry .lb-device{font-size:16px;flex-shrink:0;width:24px;text-align:center}
.lb-entry .lb-best{font-family:'Orbitron',monospace;font-size:12px;opacity:0.5;flex-shrink:0;width:60px;text-align:right}
.lb-entry .lb-time{font-family:'Orbitron',monospace;font-weight:700;font-size:15px;color:#2ecc71;flex-shrink:0;width:75px;text-align:right}
.lb-entry:nth-child(2) .lb-time{color:#f1c40f}
.lb-entry:nth-child(3) .lb-time{color:#bdc3c7}
.lb-entry:nth-child(4) .lb-time{color:#e67e22}
.ranking-close-btn{margin-top:20px;padding:12px 36px;background:rgba(255,255,255,0.1);border:2px solid rgba(255,255,255,0.2);border-radius:14px;color:#fff;font-family:'Noto Sans KR',sans-serif;font-size:15px;font-weight:700;cursor:pointer;transition:all 0.2s ease}
.ranking-close-btn:hover{background:rgba(255,255,255,0.2)}
.ranking-empty{padding:40px 20px;opacity:0.5;font-size:15px}
.ranking-loading{padding:40px 20px;font-size:15px;opacity:0.6}
.ranking-error{padding:20px;color:#e74c3c;font-size:14px}

/* â”€â”€ Idle Ranking Btn â”€â”€ */
.idle-ranking-btn{margin-top:8px;padding:10px 24px;background:rgba(255,255,255,0.1);border:2px solid rgba(255,255,255,0.2);border-radius:12px;color:#fff;font-family:'Noto Sans KR',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all 0.2s ease}
.idle-ranking-btn:hover{background:rgba(255,255,255,0.2);transform:translateY(-2px)}
body.light-mode .idle-ranking-btn{background:rgba(0,0,0,0.05);border-color:rgba(0,0,0,0.12);color:#1a1a2e}

/* â”€â”€ Toast â”€â”€ */
.toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%) translateY(20px);background:rgba(46,204,113,0.9);color:#fff;padding:12px 28px;border-radius:14px;font-weight:700;font-size:15px;z-index:300;opacity:0;transition:all 0.4s ease;pointer-events:none}
.toast.toast-error{background:rgba(231,76,60,0.9)}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* â”€â”€ Status Label (accessibility) â”€â”€ */
.status-label{font-size:13px;font-weight:700;letter-spacing:1px;text-transform:uppercase;opacity:0.7;margin-top:4px}
</style>
</head>
<body>
<div class="particles" id="particles"></div>
<div class="flash-overlay" id="flash"></div>
<div class="round-bar" id="roundBar"></div>
<div class="top-controls" id="topControls">
  <button class="ctrl-btn" id="btnSound" title="ì‚¬ìš´ë“œ í† ê¸€">ğŸ”Š</button>
  <button class="ctrl-btn" id="btnTheme" title="í…Œë§ˆ í† ê¸€">ğŸŒ™</button>
</div>
<div id="app"></div>
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Firebase (compat CDN - works with file://)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
  const s1 = document.createElement('script');
  s1.src = 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js';
  const s2 = document.createElement('script');
  s2.src = 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js';
  s1.onload = () => { document.head.appendChild(s2); };
  s2.onload = () => { initFirebase(); };
  s1.onerror = s2.onerror = () => { console.warn('Firebase CDN load failed'); };
  document.head.appendChild(s1);
})();

const firebaseConfig = {
  apiKey: "AIzaSyAzMJKQJq3KrpCku9_oN0FQkBtYZHXUM38",
  authDomain: "gamedata-f49bd.firebaseapp.com",
  projectId: "gamedata-f49bd",
  storageBucket: "gamedata-f49bd.firebasestorage.app",
  messagingSenderId: "638830085387",
  appId: "1:638830085387:web:1ca04241b20bfd8cde8e0e",
  measurementId: "G-41CHL8RJSY"
};

let db = null;
let firebaseReady = false;

function initFirebase() {
  try {
    if (typeof firebase === 'undefined') return;
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    firebaseReady = true;
    console.log('Firebase connected');
  } catch(e) { console.warn('Firebase init failed:', e); }
}

function getDeviceType() {
  return /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent) ? 'Mobile' : 'PC';
}

async function fbSave({ nickname, avgTime, bestTime, attempts, grade }) {
  if (!firebaseReady) throw new Error('offline');
  const ref = await db.collection('rankings').add({
    nickname, avgTime, bestTime, attempts, grade,
    deviceType: getDeviceType(),
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  return ref.id;
}

async function fbLoad(topN = 20) {
  if (!firebaseReady) return [];
  const snap = await db.collection('rankings').orderBy('avgTime','asc').limit(topN).get();
  return snap.docs.map(d => ({ id: d.id, ...d.data() }));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Sound Engine (Web Audio API)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let audioCtx = null;
let soundEnabled = true;

function ensureAudio() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
}

function playBeep(freq = 800, duration = 0.1, type = 'sine', vol = 0.3) {
  if (!soundEnabled) return;
  try {
    ensureAudio();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    gain.gain.setValueAtTime(vol, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + duration);
  } catch(e) {}
}

function playCountBeep() { playBeep(600, 0.12, 'square', 0.15); }
function playGoBeep() { playBeep(1200, 0.2, 'sine', 0.25); }
function playClickSound() { playBeep(400, 0.06, 'triangle', 0.1); }
function playCelebration() {
  if (!soundEnabled) return;
  [0, 100, 200, 300].forEach((delay, i) => {
    setTimeout(() => playBeep(800 + i * 200, 0.15, 'sine', 0.15), delay);
  });
}
function playGoodResult() { playBeep(1000, 0.15, 'sine', 0.2); setTimeout(() => playBeep(1400, 0.2, 'sine', 0.2), 120); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Theme
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let darkMode = true;
let gameActive = false; // true during WAITING/READY/TOO_EARLY

function applyTheme() {
  if (gameActive) { document.body.classList.remove('light-mode'); return; }
  if (darkMode) document.body.classList.remove('light-mode');
  else document.body.classList.add('light-mode');
  document.getElementById('btnTheme').textContent = darkMode ? 'ğŸŒ™' : 'â˜€ï¸';
}

// Detect system preference
if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
  darkMode = false;
}

document.getElementById('btnTheme').addEventListener('click', (e) => {
  e.stopPropagation();
  darkMode = !darkMode;
  applyTheme();
});

document.getElementById('btnSound').addEventListener('click', (e) => {
  e.stopPropagation();
  soundEnabled = !soundEnabled;
  document.getElementById('btnSound').textContent = soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Game State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STATES = { IDLE:'IDLE', COUNTDOWN:'COUNTDOWN', WAITING:'WAITING', READY:'READY', RESULT:'RESULT', TOO_EARLY:'TOO_EARLY', FINAL:'FINAL' };
const MAX_ROUNDS = 5;
const GRADES = [
  { max:150, emoji:'âš¡', text:'ë²ˆê°œ ë°˜ì‚¬ì‹ ê²½!' },
  { max:250, emoji:'ğŸ”¥', text:'ë§¤ìš° ë¹ ë¦„!' },
  { max:350, emoji:'ğŸ‘', text:'í‰ê·  ì´ìƒ!' },
  { max:500, emoji:'ğŸ˜Š', text:'ë³´í†µ' },
  { max:Infinity, emoji:'ğŸ¢', text:'ì¡°ê¸ˆ ëŠë ¤ìš”~' },
];
const BG = {
  IDLE: () => darkMode ? '#1a1a2e' : '#e8f4fd',
  COUNTDOWN: () => 'rgba(0,0,0,0.9)',
  WAITING: () => '#e74c3c',
  READY: () => '#2ecc71',
  RESULT: () => darkMode ? '#1a1a2e' : '#f0f4f8',
  TOO_EARLY: () => '#e67e22',
  FINAL: () => darkMode ? '#1a1a2e' : '#f0f4f8',
};

let state = STATES.IDLE;
let round = 0;
let results = [];
let startTime = 0;
let waitTimeout = null;
let registeredDocId = null;
let clickBlocked = false;

const $ = s => document.querySelector(s);
const appEl = $('#app');
const roundBar = $('#roundBar');
const flash = $('#flash');
const toastEl = $('#toast');

// â”€â”€ Helpers â”€â”€
function showToast(msg, isErr = false) {
  toastEl.textContent = msg;
  toastEl.className = 'toast' + (isErr ? ' toast-error' : '');
  requestAnimationFrame(() => toastEl.classList.add('show'));
  setTimeout(() => toastEl.classList.remove('show'), 2500);
}

function createParticles() {
  const c = $('#particles');
  for (let i = 0; i < 20; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    const sz = Math.random() * 60 + 10;
    p.style.width = sz + 'px'; p.style.height = sz + 'px';
    p.style.left = Math.random() * 100 + '%';
    p.style.animationDuration = (Math.random() * 10 + 8) + 's';
    p.style.animationDelay = (Math.random() * 10) + 's';
    c.appendChild(p);
  }
}

function setBg(s) {
  gameActive = (s === 'WAITING' || s === 'READY' || s === 'TOO_EARLY' || s === 'COUNTDOWN');
  document.body.style.background = BG[s]();
  applyTheme();
}

function getGrade(ms) { return GRADES.find(g => ms <= g.max); }

function flashScreen() {
  flash.classList.add('flash');
  setTimeout(() => flash.classList.remove('flash'), 100);
}

function createRipple(x, y) {
  const r = document.createElement('div');
  r.className = 'ripple';
  r.style.left = (x - 50) + 'px'; r.style.top = (y - 50) + 'px';
  r.style.width = '100px'; r.style.height = '100px';
  document.body.appendChild(r);
  setTimeout(() => r.remove(), 600);
}

function esc(str) { const d = document.createElement('div'); d.textContent = str; return d.innerHTML; }

// â”€â”€ Celebration Effects â”€â”€
function spawnConfetti(container, count = 40) {
  const colors = ['#f1c40f','#e74c3c','#2ecc71','#3498db','#9b59b6','#e67e22','#00d4ff','#ff006e'];
  for (let i = 0; i < count; i++) {
    const c = document.createElement('div');
    c.className = 'confetti';
    c.style.left = Math.random() * 100 + '%';
    c.style.top = '-10px';
    c.style.background = colors[Math.floor(Math.random() * colors.length)];
    c.style.animationDuration = (Math.random() * 1.5 + 1) + 's';
    c.style.animationDelay = (Math.random() * 0.5) + 's';
    c.style.width = (Math.random() * 6 + 4) + 'px';
    c.style.height = (Math.random() * 6 + 4) + 'px';
    container.appendChild(c);
  }
}

function spawnSparkles(container, count = 20) {
  for (let i = 0; i < count; i++) {
    const s = document.createElement('div');
    s.className = 'sparkle';
    s.style.left = Math.random() * 100 + '%';
    s.style.top = Math.random() * 100 + '%';
    s.style.background = Math.random() > 0.5 ? '#f1c40f' : '#fff';
    s.style.animationDelay = (Math.random() * 0.8) + 's';
    s.style.animationDuration = (Math.random() * 0.6 + 0.6) + 's';
    container.appendChild(s);
  }
}

// â”€â”€ Round Bar â”€â”€
function renderRoundBar() {
  roundBar.innerHTML = '';
  if ((state === STATES.IDLE || state === STATES.COUNTDOWN) && round === 0) { roundBar.classList.remove('visible'); return; }
  roundBar.classList.add('visible');
  for (let i = 0; i < MAX_ROUNDS; i++) {
    const dot = document.createElement('div');
    dot.className = 'round-dot';
    if (i < results.length) {
      dot.classList.add('success');
      const t = document.createElement('span');
      t.className = 'dot-time'; t.textContent = results[i].time + 'ms';
      dot.appendChild(t);
    } else if (i === results.length) {
      dot.classList.add('active');
    }
    roundBar.appendChild(dot);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Render Functions
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderIdle() {
  appEl.innerHTML = `
    <div class="content">
      <div class="icon" style="font-size:48px;animation:none;">ğŸ¯</div>
      <div class="neon-title">ìˆœë°œë ¥ í…ŒìŠ¤íŠ¸</div>
      <div class="neon-subtitle">Reaction Time</div>
      <div class="idle-desc">
        <div class="idle-desc-item">ğŸŸ¢ í™”ë©´ì´ ì´ˆë¡ìƒ‰ìœ¼ë¡œ ë°”ë€Œë©´ í´ë¦­!</div>
        <div class="idle-desc-item">â±ï¸ 5íšŒ ì¸¡ì • í›„ í‰ê·  ë°˜ì‘ì†ë„ í™•ì¸</div>
        <div class="idle-desc-item">ğŸ† ë­í‚¹ì— ë“±ë¡í•˜ê³  ì¹œêµ¬ì™€ ë¹„êµí•˜ì„¸ìš”</div>
      </div>
      <button class="start-btn" id="btnStart">ê²Œì„ ì‹œì‘</button>
      <button class="idle-ranking-btn" id="btnIdleRank">ğŸ† ë­í‚¹ ë³´ê¸°</button>
    </div>`;
  $('#btnStart').addEventListener('click', e => { e.stopPropagation(); ensureAudio(); startGame(); });
  $('#btnIdleRank').addEventListener('click', e => { e.stopPropagation(); showRankingBoard(); });
}

function renderCountdown(num) {
  // Overlay approach
  let ov = document.getElementById('countdownOv');
  if (!ov) {
    ov = document.createElement('div');
    ov.id = 'countdownOv';
    ov.className = 'countdown-overlay';
    document.body.appendChild(ov);
  }
  ov.innerHTML = `<div class="countdown-num">${num}</div><div class="countdown-label">ì¤€ë¹„í•˜ì„¸ìš”</div>`;
}

function removeCountdown() {
  const ov = document.getElementById('countdownOv');
  if (ov) ov.remove();
}

function renderWaiting() {
  appEl.innerHTML = `
    <div class="content">
      <div class="icon">ğŸ”´</div>
      <div class="title" style="font-size:clamp(22px,5vw,36px);">ê¸°ë‹¤ë¦¬ì„¸ìš”...</div>
      <div class="subtitle">ì´ˆë¡ìƒ‰ìœ¼ë¡œ ë°”ë€Œë©´ í´ë¦­!</div>
      <div class="status-label">â³ ëŒ€ê¸° ì¤‘</div>
    </div>`;
}

function renderReady() {
  appEl.innerHTML = `
    <div class="content">
      <div class="icon">ğŸŸ¢</div>
      <div class="title">ì§€ê¸ˆ í´ë¦­í•˜ì„¸ìš”!</div>
      <div class="status-label">âœ… ì§€ê¸ˆ!</div>
    </div>`;
}

function renderResult(ms) {
  const g = getGrade(ms);
  const prevTime = results.length > 1 ? results[results.length - 2].time : null;
  let compHtml = '';
  if (prevTime !== null) {
    const diff = ms - prevTime;
    if (diff < 0) compHtml = `<div class="comparison improved">â–² ${Math.abs(diff)}ms í–¥ìƒ!</div>`;
    else if (diff > 0) compHtml = `<div class="comparison declined">â–¼ ${diff}ms ëŠë ¤ì§</div>`;
    else compHtml = `<div class="comparison" style="opacity:0.5">â€” ë™ì¼</div>`;
  }

  let celebClass = '';
  if (ms <= 150) celebClass = 'confetti';
  else if (ms <= 250) celebClass = 'sparkle';

  appEl.innerHTML = `
    <div class="content">
      <div class="result-card" id="resultCard">
        <div class="celebration" id="celebArea"></div>
        <div class="icon">${g.emoji}</div>
        <div class="time-display">${ms}<span class="time-unit">ms</span></div>
        <div class="grade">${g.text}</div>
        ${compHtml}
      </div>
      <div class="hint">${round < MAX_ROUNDS ? 'í´ë¦­í•˜ì—¬ ë‹¤ìŒ ë¼ìš´ë“œ' : ''}</div>
    </div>`;

  // Celebration effects
  const area = document.getElementById('celebArea');
  if (celebClass === 'confetti') { spawnConfetti(area, 50); playCelebration(); }
  else if (celebClass === 'sparkle') { spawnSparkles(area, 25); playGoodResult(); }
  else { playClickSound(); }
}

function renderTooEarly() {
  appEl.innerHTML = `
    <div class="content">
      <div class="icon">âš ï¸</div>
      <div class="title" style="font-size:clamp(22px,5vw,32px);">ë„ˆë¬´ ë¹¨ë¦¬ í´ë¦­í–ˆìŠµë‹ˆë‹¤!</div>
      <div class="subtitle">ì´ ë¼ìš´ë“œë¥¼ ë‹¤ì‹œ ì‹œë„í•©ë‹ˆë‹¤</div>
      <div class="status-label">âš ï¸ ì¡°ê¸° í´ë¦­</div>
      <div class="hint">í´ë¦­í•˜ì—¬ ì¬ì‹œë„</div>
    </div>`;
}

function renderFinal() {
  const times = results.map(r => r.time);
  const avg = Math.round(times.reduce((a, b) => a + b, 0) / times.length);
  const best = Math.min(...times);
  const worst = Math.max(...times);
  const grade = getGrade(avg);
  const maxBar = Math.max(...times, 1);

  const barsHtml = times.map((t, i) => {
    const h = Math.max(8, (t / maxBar) * 100);
    return `<div class="bar-col">
      <div class="bar-value">${t}</div>
      <div class="bar" style="height:${h}%"></div>
      <div class="bar-label">${i + 1}</div>
    </div>`;
  }).join('');

  const rankBtn = registeredDocId
    ? '<button class="btn btn-secondary" disabled style="opacity:0.4;">âœ… ë“±ë¡ ì™„ë£Œ</button>'
    : '<button class="btn btn-secondary" id="btnRank">ğŸ† ë­í‚¹ ë“±ë¡</button>';

  appEl.innerHTML = `
    <div class="content">
      <div class="summary-card">
        <div class="summary-title">ìµœì¢… ê²°ê³¼</div>
        <div class="icon">${grade.emoji}</div>
        <div class="summary-avg">${avg}<span class="time-unit">ms</span></div>
        <div class="grade-badge">${grade.emoji} ${grade.text}</div>
        <div class="summary-stats">
          <div class="stat-item">ìµœê³ <span class="stat-value" style="color:#2ecc71">${best}ms</span></div>
          <div class="stat-item">ìµœì €<span class="stat-value" style="color:#e74c3c">${worst}ms</span></div>
          <div class="stat-item">í¸ì°¨<span class="stat-value">${worst - best}ms</span></div>
        </div>
        <div class="bar-graph">${barsHtml}</div>
        <div class="btn-group">
          <button class="btn btn-primary" id="btnRetry">ë‹¤ì‹œ í•˜ê¸°</button>
          ${rankBtn}
        </div>
        <div class="btn-group" style="margin-top:8px">
          <button class="btn btn-secondary" id="btnShare">ğŸ“¤ ê²°ê³¼ ê³µìœ </button>
          <button class="btn btn-secondary" id="btnViewRank">ğŸ“Š ë­í‚¹ ë³´ê¸°</button>
        </div>
      </div>
    </div>`;

  // Animate bars
  setTimeout(() => {
    document.querySelectorAll('.bar').forEach(bar => { bar.style.transition = 'height 0.6s cubic-bezier(0.34,1.56,0.64,1)'; });
  }, 50);

  $('#btnRetry').addEventListener('click', e => { e.stopPropagation(); resetGame(); });
  const br = $('#btnRank');
  if (br) br.addEventListener('click', e => { e.stopPropagation(); showRegisterModal(avg, best, grade); });
  $('#btnShare').addEventListener('click', e => { e.stopPropagation(); shareResult(avg, best, grade); });
  $('#btnViewRank').addEventListener('click', e => { e.stopPropagation(); showRankingBoard(); });

  if (avg <= 250) playCelebration();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Share
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function shareResult(avg, best, grade) {
  const text = `ğŸ¯ ìˆœë°œë ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼\ní‰ê· : ${avg}ms | ìµœê³ : ${best}ms\në“±ê¸‰: ${grade.emoji} ${grade.text}\në„ì „í•´ë³´ì„¸ìš”! â†’ https://jj0206.github.io/reaction_time_test/reaction-time-test.html`;

  if (navigator.share) {
    try {
      await navigator.share({ title: 'ìˆœë°œë ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼', text });
      showToast('ê³µìœ  ì™„ë£Œ!');
    } catch (e) { if (e.name !== 'AbortError') copyToClipboard(text); }
  } else {
    copyToClipboard(text);
  }
}

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(
    () => showToast('ğŸ“‹ ê²°ê³¼ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!'),
    () => showToast('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', true)
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Firebase UI - Register Modal
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showRegisterModal(avg, best, grade) {
  if (!firebaseReady) { showToast('ì„œë²„ ì—°ê²° ì‹¤íŒ¨. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', true); return; }

  const ov = document.createElement('div');
  ov.className = 'modal-overlay';
  ov.innerHTML = `
    <div class="modal">
      <h3>ğŸ† ë­í‚¹ ë“±ë¡</h3>
      <div class="result-preview">
        <div class="preview-item">í‰ê· <span class="preview-value">${avg}ms</span></div>
        <div class="preview-item">ìµœê³ <span class="preview-value">${best}ms</span></div>
        <div class="preview-item">ë“±ê¸‰<span class="preview-value">${grade.emoji}</span></div>
      </div>
      <input type="text" id="rnkName" placeholder="ë‹‰ë„¤ì„ (2~10ì, í•œê¸€/ì˜ë¬¸/ìˆ«ì)" maxlength="10" autocomplete="off">
      <div class="input-error" id="rnkErr"></div>
      <div class="btn-group">
        <button class="btn btn-primary" id="rnkSave">ë“±ë¡í•˜ê¸°</button>
        <button class="btn btn-secondary" id="rnkCancel">ì·¨ì†Œ</button>
      </div>
    </div>`;
  document.body.appendChild(ov);

  const inp = ov.querySelector('#rnkName');
  const errEl = ov.querySelector('#rnkErr');
  const saveBtn = ov.querySelector('#rnkSave');
  inp.focus();

  function validate(n) {
    if (n.length < 2) return 'ë‹‰ë„¤ì„ì€ 2ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.';
    if (n.length > 10) return 'ë‹‰ë„¤ì„ì€ 10ì ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.';
    if (!/^[ê°€-í£a-zA-Z0-9]+$/.test(n)) return 'í•œê¸€, ì˜ë¬¸, ìˆ«ìë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.';
    return null;
  }

  const doSave = async () => {
    const name = inp.value.trim();
    const err = validate(name);
    if (err) { errEl.textContent = err; inp.style.borderColor = '#e74c3c'; return; }
    saveBtn.innerHTML = '<span class="spinner"></span>ë“±ë¡ ì¤‘...';
    saveBtn.disabled = true;
    errEl.textContent = '';
    try {
      const docId = await fbSave({ nickname: name, avgTime: avg, bestTime: best, attempts: results.map(r => r.time), grade: grade.emoji + ' ' + grade.text });
      registeredDocId = docId;
      ov.remove();
      showToast('ğŸ‰ ë­í‚¹ ë“±ë¡ ì™„ë£Œ!');
      renderFinal();
    } catch (error) {
      console.error('Save failed:', error);
      saveBtn.innerHTML = 'ì¬ì‹œë„';
      saveBtn.disabled = false;
      errEl.textContent = 'ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
    }
  };

  saveBtn.addEventListener('click', e => { e.stopPropagation(); doSave(); });
  ov.querySelector('#rnkCancel').addEventListener('click', e => { e.stopPropagation(); ov.remove(); });
  inp.addEventListener('keydown', e => { if (e.key === 'Enter') doSave(); });
  ov.addEventListener('click', e => { if (e.target === ov) ov.remove(); });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Firebase UI - Ranking Board
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function showRankingBoard() {
  const ov = document.createElement('div');
  ov.className = 'ranking-modal-overlay';
  ov.innerHTML = `
    <div class="ranking-modal">
      <h2>ğŸ† ë­í‚¹ ë³´ë“œ</h2>
      <div id="rkContent"><div class="ranking-loading"><span class="spinner"></span> ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div>
      <button class="ranking-close-btn" id="rkClose">ë‹«ê¸°</button>
    </div>`;
  document.body.appendChild(ov);

  ov.querySelector('#rkClose').addEventListener('click', e => { e.stopPropagation(); ov.remove(); });
  ov.addEventListener('click', e => { if (e.target === ov) ov.remove(); });

  const ct = ov.querySelector('#rkContent');
  if (!firebaseReady) {
    ct.innerHTML = '<div class="ranking-error">ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.</div>';
    return;
  }
  try {
    const data = await fbLoad(20);
    if (data.length === 0) {
      ct.innerHTML = '<div class="ranking-empty">ì•„ì§ ë“±ë¡ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì²« ë²ˆì§¸ ë„ì „ìê°€ ë˜ì–´ë³´ì„¸ìš”! ğŸš€</div>';
      return;
    }
    const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
    let html = `<div class="lb-header"><span class="lbh-rank">#</span><span class="lbh-name">ë‹‰ë„¤ì„</span><span class="lbh-device"></span><span class="lbh-best">ìµœê³ </span><span class="lbh-time">í‰ê· </span></div>`;
    data.forEach((e, i) => {
      const me = e.id === registeredDocId;
      const dev = e.deviceType === 'Mobile' ? 'ğŸ“±' : 'ğŸ–¥ï¸';
      const rk = i < 3 ? medals[i] : (i + 1);
      html += `<div class="lb-entry${me ? ' lb-highlight' : ''}" style="animation-delay:${i * 0.04}s"><span class="lb-rank">${rk}</span><span class="lb-name">${esc(e.nickname)}${me ? ' â­' : ''}</span><span class="lb-device">${dev}</span><span class="lb-best">${e.bestTime || 'â€”'}ms</span><span class="lb-time">${e.avgTime}ms</span></div>`;
    });
    ct.innerHTML = html;
  } catch (err) {
    console.error('Load failed:', err);
    ct.innerHTML = '<div class="ranking-error">ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.</div>';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Countdown & State Machine
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startGame() {
  results = [];
  round = 1;
  registeredDocId = null;
  clickBlocked = true;
  state = STATES.COUNTDOWN;
  setBg('COUNTDOWN');
  renderRoundBar();
  appEl.innerHTML = '';

  let count = 3;
  renderCountdown(count);
  playCountBeep();

  const interval = setInterval(() => {
    count--;
    if (count > 0) {
      renderCountdown(count);
      playCountBeep();
    } else {
      clearInterval(interval);
      removeCountdown();
      clickBlocked = false;
      transition(STATES.WAITING);
    }
  }, 800);
}

function transition(newState, data) {
  state = newState;
  setBg(state);
  renderRoundBar();
  switch (state) {
    case STATES.IDLE: renderIdle(); break;
    case STATES.WAITING:
      renderWaiting();
      waitTimeout = setTimeout(() => transition(STATES.READY), 2000 + Math.random() * 3000);
      break;
    case STATES.READY:
      flashScreen();
      playGoBeep();
      startTime = performance.now();
      renderReady();
      break;
    case STATES.RESULT:
      flashScreen();
      results.push({ time: data });
      renderResult(data);
      break;
    case STATES.TOO_EARLY: renderTooEarly(); break;
    case STATES.FINAL: renderFinal(); break;
  }
}

// â”€â”€ Input Handler â”€â”€
function handleInput(e) {
  if (clickBlocked) return;

  // Prevent double fire
  if (e.type === 'touchstart') e.preventDefault();

  const x = e.clientX || (e.touches?.[0]?.clientX ?? innerWidth / 2);
  const y = e.clientY || (e.touches?.[0]?.clientY ?? innerHeight / 2);
  createRipple(x, y);
  playClickSound();

  switch (state) {
    case STATES.IDLE: startGame(); break;
    case STATES.WAITING:
      clearTimeout(waitTimeout);
      transition(STATES.TOO_EARLY);
      break;
    case STATES.READY:
      transition(STATES.RESULT, Math.round(performance.now() - startTime));
      break;
    case STATES.RESULT:
      if (round < MAX_ROUNDS) { round++; transition(STATES.WAITING); }
      else transition(STATES.FINAL);
      break;
    case STATES.TOO_EARLY:
      transition(STATES.WAITING);
      break;
    case STATES.FINAL: break;
  }
}

function resetGame() {
  state = STATES.IDLE; round = 0; results = []; registeredDocId = null;
  clickBlocked = false;
  clearTimeout(waitTimeout);
  setBg(STATES.IDLE);
  renderRoundBar();
  renderIdle();
}

// â”€â”€ Keyboard support â”€â”€
document.addEventListener('keydown', (e) => {
  if (e.code === 'Space' || e.key === ' ') {
    e.preventDefault();
    handleInput({ clientX: innerWidth / 2, clientY: innerHeight / 2, type: 'keydown' });
  }
});

// â”€â”€ Init â”€â”€
createParticles();
applyTheme();
transition(STATES.IDLE);
document.body.addEventListener('click', handleInput);
document.body.addEventListener('touchstart', handleInput, { passive: false });
document.body.addEventListener('contextmenu', e => e.preventDefault());
</script>
</body>
</html>
